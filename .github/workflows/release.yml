name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Import signing certificate
        env:
          CERT_P12_BASE64: ${{ secrets.SIGN_CERT_P12_BASE64 }}
          CERT_PASSWORD: ${{ secrets.SIGN_CERT_PASSWORD }}
        run: |
          if [[ -z "$CERT_P12_BASE64" ]]; then
            echo "Missing SIGN_CERT_P12_BASE64 secret" >&2
            exit 1
          fi
          KEYCHAIN=build.keychain
          echo "$CERT_P12_BASE64" | base64 --decode > signing.p12
          security create-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security import signing.p12 -k "$KEYCHAIN" -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

      - name: Build, sign, notarize, package
        env:
          SIGN_IDENTITY: ${{ secrets.SIGN_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          NOTARY_PASSWORD: ${{ secrets.NOTARY_PASSWORD }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          if [[ -z "$SIGN_IDENTITY" ]]; then
            echo "Missing SIGN_IDENTITY secret" >&2
            exit 1
          fi
          ./scripts/release_cask.sh

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            dist/Werd-*.zip
            dist/cask.rb

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Package
        run: bunx electron-builder --publish never

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Package
        run: bunx electron-builder --publish never

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: dist/*.AppImage

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="$(node -p "require('./package.json').version")"
          TAG="v${VERSION}"

          # Create release if it doesn't exist
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --title "$TAG" --notes "Automated release for $TAG"

          # Upload macOS zip
          for f in artifacts/macos-build/Werd-*.zip; do
            [ -f "$f" ] && gh release upload "$TAG" "$f" --clobber
          done

          # Upload Windows installer
          for f in artifacts/windows-build/*.exe; do
            [ -f "$f" ] && gh release upload "$TAG" "$f" --clobber
          done

          # Upload Linux AppImage
          for f in artifacts/linux-build/*.AppImage; do
            [ -f "$f" ] && gh release upload "$TAG" "$f" --clobber
          done

      - name: Update tap repository
        env:
          TAP_REPO: ${{ secrets.HOMEBREW_TAP_REPO }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          TAP_REPO="${TAP_REPO:-kluzzebass/homebrew-tap}"
          if [[ -z "$TAP_TOKEN" ]]; then
            echo "Missing TAP_TOKEN secret" >&2
            exit 1
          fi
          TAP_DIR="$(mktemp -d)"
          git clone "https://$TAP_TOKEN@github.com/$TAP_REPO.git" "$TAP_DIR"
          mkdir -p "$TAP_DIR/Casks"
          cp artifacts/macos-build/cask.rb "$TAP_DIR/Casks/werd.rb"
          cd "$TAP_DIR"
          git add Casks/werd.rb
          if git diff --cached --quiet; then
            echo "Tap already up to date."
            exit 0
          fi
          VERSION="$(ruby -ne 'puts $1 if $_ =~ /version \"([^\"]+)\"/' Casks/werd.rb | head -n 1)"
          git -c user.name="github-actions" -c user.email="github-actions@github.com" \
            commit -m "Update werd cask to ${VERSION}"
          git push

  deploy-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build web version
        run: bun run build:web

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist-web

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
